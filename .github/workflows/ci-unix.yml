#
# Implementation of Continuous Integration process for UNIX by Github actions (with extra additionals...)
#
name: "CI"

on:
  push:
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [master]

jobs:
  ci-freebsd-qt5:
    name: "FreeBSD (x86_64; qt5)"
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.actor, 'transifex')"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build and run unit tests in FreeBSD
      uses: vmactions/freebsd-vm@v1
      id: freebsd-qt5
      with:
        # Use sh shell
        usesh: true
        # When using rsync, you can define copyback: false to not copy files back from the VM in to the host.
        copyback: false
        prepare: |
          pkg install -y cmake qxlsx exiv2 nlopt perl5 xorg-vfbserver gettext calcmysky qt5-buildtools qt5-charts qt5-concurrent qt5-core qt5-declarative qt5-gui qt5-script qt5-serialport qt5-qmake qt5-webengine qt5-widgets qt5-testlib qt5-linguisttools qt5-location qt5-network qt5-multimedia qt5-opengl

        run: |
          set -e -x
          export DISPLAY=:0
          mkdir builds
          cd builds
          cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_TESTING=On "${{ github.workspace }}"
          make -j3
          Xvfb :0 -ac -screen 0 1024x768x24+32 >/dev/null 2>&1 &
          sleep 3
          ctest --output-on-failure
          pkill Xvfb

  ci-freebsd-qt6:
    name: "FreeBSD (x86_64; qt6)"
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.actor, 'transifex')"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build and run unit tests in FreeBSD
      uses: vmactions/freebsd-vm@v1
      id: freebsd-qt6
      with:
        # Use sh shell
        usesh: true
        # When using rsync, you can define copyback: false to not copy files back from the VM in to the host.
        copyback: false
        prepare: |
          pkg install -y cmake exiv2 nlopt perl5 xorg-vfbserver gettext qt6-webengine qt6-base qt6-tools qt6-serialport qt6-location qt6-positioning qt6-multimedia qt6-charts 

        run: |
          set -e -x
          export DISPLAY=:0
          mkdir builds
          cd builds
          cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_TESTING=On -DENABLE_SHOWMYSKY=Off "${{ github.workspace }}"
          make -j3
          Xvfb :0 -ac -screen 0 1024x768x24+32 >/dev/null 2>&1 &
          sleep 3
          ctest --output-on-failure
          pkill Xvfb

  ci-openbsd-qt5:
    name: "OpenBSD (x86_64; qt5)"
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.actor, 'transifex')"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build and run unit tests in OpenBSD
      uses: vmactions/openbsd-vm@v1
      id: openbsd-qt5
      with:
        # Use sh shell
        usesh: true
        # When using rsync, you can define copyback: false to not copy files back from the VM in to the host.
        copyback: false
        prepare: |
          pkg_add cmake eigen3 glm exiv2 nlopt gpsd qt5-qxlsx qt5 qtbase qtscript qtserialport qtdeclarative qtmultimedia qtcharts qttools qtlocation qtwebengine

        run: |
          set -e -x
          export DISPLAY=:0
          mkdir builds
          cd builds
          cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_TESTING=On -DENABLE_QTWEBENGINE=Off -DENABLE_SHOWMYSKY=Off "${{ github.workspace }}"
          make -j3
          Xvfb :0 -ac -screen 0 1024x768x24+32 >/dev/null 2>&1 &
          sleep 3
          ctest --output-on-failure
          pkill Xvfb

  ci-openbsd-qt6:
    name: "OpenBSD (x86_64; qt6)"
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.actor, 'transifex')"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build and run unit tests in OpenBSD
      uses: vmactions/openbsd-vm@v1
      id: openbsd-qt6
      with:
        # Use sh shell
        usesh: true
        # When using rsync, you can define copyback: false to not copy files back from the VM in to the host.
        copyback: false
        prepare: |
          pkg_add cmake calcmysky eigen3 glm exiv2 nlopt gpsd qt6-qxlsx qt6

        run: |
          set -e -x
          export DISPLAY=:0
          mkdir builds
          cd builds
          cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_TESTING=On -DENABLE_QTWEBENGINE=Off "${{ github.workspace }}"
          make -j3
          Xvfb :0 -ac -screen 0 1024x768x24+32 >/dev/null 2>&1 &
          sleep 3
          ctest --output-on-failure
          pkill Xvfb
