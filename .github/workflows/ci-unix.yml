#
# Implementation of Continuous Integration process for UNIX by Github actions (with extra additionals...)
#
name: "CI"

on:
  push:
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [master]

jobs:
  ci-freebsd-qt5:
    name: "FreeBSD (x86_64; qt5)"
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.actor, 'transifex')"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build and run unit tests in FreeBSD
      uses: vmactions/freebsd-vm@v1
      id: freebsd-qt5
      with:
        # Use sh shell
        usesh: true
        # When using rsync, you can define copyback: false to not copy files back from the VM in to the host.
        copyback: false
        prepare: |
          pkg install -y cmake qxlsx exiv2 nlopt perl5 xorg-vfbserver gettext calcmysky qt5-buildtools qt5-charts qt5-concurrent qt5-core qt5-declarative qt5-gui qt5-script qt5-serialport qt5-qmake qt5-webengine qt5-widgets qt5-testlib qt5-linguisttools qt5-location qt5-network qt5-multimedia qt5-opengl

        run: |
          set -e -x
          export DISPLAY=:0
          mkdir builds
          cd builds
          cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_TESTING=On "${{ github.workspace }}"
          make -j3
          Xvfb :0 -ac -screen 0 1024x768x24+32 >/dev/null 2>&1 &
          sleep 3
          ctest --output-on-failure
          xvfb_pids=`ps aux | grep Xvfb | grep -v grep | awk '{print $2}'`
          if [ "$xvfb_pids" != "" ]; then
             kill $xvfb_pids
          fi

  ci-netbsd-qt5:
    name: "NetBSD (x86_64; qt5)"
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.actor, 'transifex')"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build and run unit tests in NetBSD
      uses: vmactions/netbsd-vm@v1
      id: netbsd-qt5
      with:
        release: "9.0"
        # Use sh shell
        usesh: true
        prepare: |
          /usr/sbin/pkg_add cmake qt5-qtscript qt5-qtserialport qt5-qttools qt5-qtdeclarative qt5-qtlocation qt5-qtbase qt5-qtmultimedia qt5-qtscript glu libdrm MesaLib exiv2 nlopt gettext 

        run: |
          set -e -x
          export PATH=/usr/pkg/qt5/bin:$PATH
          export DISPLAY=:0
          mkdir builds
          cd builds
          cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_TESTING=On -DENABLE_GPS=OFF -DENABLE_SHOWMYSKY=Off "${{ github.workspace }}"
          make -j3
          Xvfb :0 -ac -screen 0 1024x768x24+32 >/dev/null 2>&1 &
          sleep 3
          ctest --output-on-failure
          xvfb_pids=`ps aux | grep Xvfb | grep -v grep | awk '{print $2}'`
          if [ "$xvfb_pids" != "" ]; then
             kill $xvfb_pids
          fi

  ci-openbsd-qt6:
    name: "OpenBSD (x86_64; qt6)"
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.actor, 'transifex')"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build and run unit tests in OpenBSD
      uses: vmactions/openbsd-vm@v1
      id: openbsd-qt6
      with:
        # Use sh shell
        usesh: true
        # When using rsync, you can define copyback: false to not copy files back from the VM in to the host.
        copyback: false
        prepare: |
          pkg_add cmake calcmysky eigen3 glm exiv2 nlopt gpsd qt6-qxlsx qt6

        run: |
          set -e -x
          export DISPLAY=:0
          mkdir builds
          cd builds
          cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_TESTING=On "${{ github.workspace }}"
          make -j3
          Xvfb :0 -ac -screen 0 1024x768x24+32 >/dev/null 2>&1 &
          sleep 3
          ctest --output-on-failure
          xvfb_pids=`ps aux | grep Xvfb | grep -v grep | awk '{print $2}'`
          if [ "$xvfb_pids" != "" ]; then
             kill $xvfb_pids
          fi

  ci-dragonflybsd-qt5:
    name: "DragonflyBSD (x86_64; qt5)"
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.actor, 'transifex')"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build and run unit tests in DragonflyBSD
      uses: vmactions/dragonflybsd-vm@v1
      id: dragonflybsd-qt5
      with:
        # Use sh shell
        usesh: true
        # When using rsync, you can define copyback: false to not copy files back from the VM in to the host.
        copyback: false
        prepare: |
          pkg install -y cmake qt5-buildtools qt5-charts qt5-concurrent qt5-core qt5-declarative qt5-gui qt5-location qt5-multimedia qt5-network qt5-opengl qt5-qmake qt5-script qt5-serialport qt5-widgets qt5-testlib qt5-linguisttools qt5-webengine qxlsx exiv2 nlopt perl5 xorg-vfbserver gettext

        run: |
          set -e -x
          export DISPLAY=:0
          mkdir builds
          cd builds
          cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_TESTING=On -DENABLE_SHOWMYSKY=Off "${{ github.workspace }}"
          make -j3
          Xvfb :0 -ac -screen 0 1024x768x24+32 >/dev/null 2>&1 &
          sleep 3
          ctest --output-on-failure
          xvfb_pids=`ps aux | grep Xvfb | grep -v grep | awk '{print $2}'`
          if [ "$xvfb_pids" != "" ]; then
             kill $xvfb_pids
          fi
